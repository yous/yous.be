<!DOCTYPE html><html lang="ko"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Gradle 환경에서 ProGuard 사용하기</title><meta name="description" content="Gradle을 이용해 배포 APK를 생성하는 방법과 함께 ProGuard 사용법을 공유한다."><meta name="keywords" content="gradle, proguard, signed, release, apk, android studio, actionbarsherlock, crashlytics, google play services sdk"><link rel="stylesheet" href="/assets/main.css"><link rel="canonical" href="https://yous.be/2014/05/15/how-to-configure-proguard-using-gradle/"><link rel="alternate" type="application/rss+xml" title="Yous" href="https://yous.be/atom.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" href="/icon-192x192.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="mask-icon" color="#2568ba" href="/safari-pinned-tab.svg"><meta name="msapplication-TileColor" content="#2568ba"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="Gradle 환경에서 ProGuard 사용하기"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/2014/05/15/how-to-configure-proguard-using-gradle/"><meta property="og:description" content="Gradle을 이용해 배포 APK를 생성하는 방법과 함께 ProGuard 사용법을 공유한다."><meta property="og:image" content="http://yous.be/images/2014/05/15/gradle_logo.gif"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Gradle 환경에서 ProGuard 사용하기"><meta name="twitter:description" content="Gradle을 이용해 배포 APK를 생성하는 방법과 함께 ProGuard 사용법을 공유한다."><meta name="twitter:image:src" content="http://yous.be/images/2014/05/15/gradle_logo.gif"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZKJJ9M5EL"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KZKJJ9M5EL'); </script><body><header class="site-header"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Gradle 환경에서 ProGuard 사용하기</h1><p class="post-meta"><time datetime="2014-05-15T09:11:13+00:00" itemprop="datePublished">2014년 5월 15일</time> • <a href="/categories/android/">Android</a></p></header><div class="post-content" itemprop="articleBody"><h2 id="gradle">Gradle</h2><p><img src="/images/2014/05/15/gradle_logo.gif" alt="Gradle" /></p><p>최근 <a href="https://developer.android.com/studio">Android Studio</a>를 통해 개발을 진행하게 되면서, 자연스럽게 <a href="https://gradle.org">Gradle</a>을 사용하게 되었다. <code class="language-plaintext highlighter-rouge">.gradle</code> 확장자를 가진 파일을 통해 빌드 설정을 자유롭게 조정할 수 있다. 이 글에서는 Gradle을 이용해 배포 APK를 생성하는 방법과 함께 <a href="https://www.guardsquare.com/en/products/proguard">ProGuard</a>를 사용법을 공유하겠다.</p><h2 id="how-to-create-release-apk-using-gradle">Gradle 환경에서 배포 APK 생성하기</h2><p>배포 APK에는 서명이 되어 있어야 하는데, 이를 위해서는 keystore 파일과 그 암호, 키 별칭, 키 암호가 필요하다. 디버그 APK에도 서명을 하지만, <a href="https://developer.android.com/studio/publish/app-signing#debug-mode">알려진 keystore 암호와 키 별칭, 키 암호</a>를 사용한다. 배포 APK의 서명을 위해 프로젝트의 <code class="language-plaintext highlighter-rouge">build.gradle</code> 파일에 다음 코드를 추가하면 된다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android</span> <span class="o">{</span>
    <span class="c1">// ...</span>

    <span class="n">signingConfigs</span> <span class="o">{</span>
        <span class="n">release</span> <span class="o">{</span>
            <span class="n">storeFile</span> <span class="nf">file</span><span class="o">(</span><span class="s2">"YOUR_KEYSTORE_PATH"</span><span class="o">)</span>
            <span class="n">storePassword</span> <span class="s2">"YOUR_KEYSTORE_PASSWORD"</span>
            <span class="n">keyAlias</span> <span class="s2">"YOUR_KEY_ALIAS"</span>
            <span class="n">keyPassword</span> <span class="s2">"YOUR_KEY_PASSWORD"</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">buildTypes</span> <span class="o">{</span>
        <span class="n">release</span> <span class="o">{</span>
            <span class="n">signingConfig</span> <span class="n">signingConfigs</span><span class="o">.</span><span class="na">release</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>이때 <code class="language-plaintext highlighter-rouge">buildTypes</code> 아래의 <code class="language-plaintext highlighter-rouge">debug</code> 항목은 굳이 명시하지 않아도 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Build-Types">기본적으로 생성</a>되며, 이 <code class="language-plaintext highlighter-rouge">buildType</code>은 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Signing-Configurations">디버그 keystore와 키를 사용하도록 설정</a>되어 있다.</p><p>다만 이때 <code class="language-plaintext highlighter-rouge">build.gradle</code> 파일에 keystore 암호와 키 암호가 평문으로 들어가게 되는데, 소스를 공개하고 있는 등의 이유로 이를 피하고 싶다면 각각의 항목을 쉘 프롬프트에서 입력받을 수 있다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signingConfigs</span> <span class="o">{</span>
    <span class="n">release</span> <span class="o">{</span>
        <span class="n">storeFile</span> <span class="nf">file</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s2">"\n\$ Enter keystore path: "</span><span class="o">))</span>
        <span class="n">storePassword</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readPassword</span><span class="o">(</span><span class="s2">"\n\$ Enter keystore password: "</span><span class="o">))</span>
        <span class="n">keyAlias</span> <span class="n">console</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s2">"\n\$ Enter key alias: "</span><span class="o">)</span>
        <span class="n">keyPassword</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readPassword</span><span class="o">(</span><span class="s2">"\n\$ Enter key password: "</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>그러나 이는 <a href="https://stackoverflow.com/questions/18328730/how-to-create-a-release-signed-apk-file-using-gradle#19210105">IDE를 통해 디버그 APK를 생성할 때 크래시</a>를 내며, 이는 그때 코드의 <code class="language-plaintext highlighter-rouge">console</code>이 <code class="language-plaintext highlighter-rouge">null</code>이라서 발생하는 오류다. 이를 해결한 최종 코드는 다음과 같다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signingConfigs</span> <span class="o">{</span>
    <span class="n">release</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Console</span> <span class="n">console</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">console</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">console</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">storeFile</span> <span class="nf">file</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s2">"\n\$ Enter keystore path: "</span><span class="o">))</span>
            <span class="n">storePassword</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readPassword</span><span class="o">(</span><span class="s2">"\n\$ Enter keystore password: "</span><span class="o">))</span>
            <span class="n">keyAlias</span> <span class="n">console</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s2">"\n\$ Enter key alias: "</span><span class="o">)</span>
            <span class="n">keyPassword</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">console</span><span class="o">.</span><span class="na">readPassword</span><span class="o">(</span><span class="s2">"\n\$ Enter key password: "</span><span class="o">))</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>디버그 APK와 배포 APK의 패키지 이름이 같으면 APK의 서명이 서로 달라 개발과 디버깅에 어려움이 있다. 이를 해결하기 위해서 <code class="language-plaintext highlighter-rouge">buildTypes</code> 아래에 <code class="language-plaintext highlighter-rouge">debug</code> 항목을 선언하여 디버그 APK의 패키지 이름을 바꿀 수 있고, 추가로 버전명도 바꿀 수 있다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buildTypes</span> <span class="o">{</span>
    <span class="n">debug</span> <span class="o">{</span>
        <span class="n">packageNameSuffix</span> <span class="s1">'.debug'</span>
        <span class="n">versionNameSuffix</span> <span class="s1">'-debug'</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>이제 터미널에서 다음 명령을 실행하면 디버그 APK와 배포 APK를 각각 얻을 수 있다. 물론 디버그 APK는 IDE로도 생성할 수 있다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./gradlew assembleDebug
<span class="nv">$ </span>./gradlew assembleRelease
</code></pre></div></div><p>Gradle은 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Android-tasks">캐멀케이스 단축키를 지원</a>해서 <code class="language-plaintext highlighter-rouge">aR</code>에 해당하는 다른 명령이 없는 한 <code class="language-plaintext highlighter-rouge">assembleRelease</code> 대신 <code class="language-plaintext highlighter-rouge">aR</code>을 사용할 수 있다.</p><h2 id="how-to-use-proguard">ProGuard 사용하기</h2><p>배포 APK를 생성할 때 ProGuard를 사용할 수도 있는데, <code class="language-plaintext highlighter-rouge">build.gradle</code>에 다음 코드를 추가하면 된다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buildTypes</span> <span class="o">{</span>
    <span class="n">release</span> <span class="o">{</span>
        <span class="n">runProguard</span> <span class="kc">true</span>
        <span class="n">proguardFile</span> <span class="nf">getDefaultProguardFile</span><span class="o">(</span><span class="s1">'proguard-android.txt'</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">getDefaultProguardFile()</code>는 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Running-ProGuard">SDK에 위치한 해당 이름의 파일을 가져와 적용</a>한다. <code class="language-plaintext highlighter-rouge">proguard-android.txt</code>와 <code class="language-plaintext highlighter-rouge">proguard-android-optimize.txt</code>가 있으며 <a href="http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Running-ProGuard">앞의 것은 최적화를 수행하지 않고, 뒤의 것은 최적화를 수행</a>한다.</p><p>추가적인 다른 <code class="language-plaintext highlighter-rouge">proguardFile</code>을 더 적용하고 싶다면 <code class="language-plaintext highlighter-rouge">proguardFiles</code>를 사용하면 된다.</p><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buildTypes</span> <span class="o">{</span>
    <span class="n">release</span> <span class="o">{</span>
        <span class="n">runProguard</span> <span class="kc">true</span>
        <span class="n">proguardFiles</span> <span class="nf">getDefaultProguardFile</span><span class="o">(</span><span class="s1">'proguard-android.txt'</span><span class="o">),</span> <span class="s1">'proguard-project.txt'</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>다른 라이브러리 프로젝트를 가져다 사용하고 있을 경우, ProGuard 사용에 있어 주의해야 한다.</p><h3 id="actionbarsherlock">ActionBarSherlock</h3><p><a href="http://actionbarsherlock.com">ActionBarSherlock</a>의 경우 ProGuard를 사용할 때, <a href="http://actionbarsherlock.com/faq.html">다음 규칙을 추가하라고 명시</a>하고 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-keep class android.support.v4.app.** { *; }
-keep interface android.support.v4.app.** { *; }
-keep class com.actionbarsherlock.** { *; }
-keep interface com.actionbarsherlock.** { *; }

-keepattributes *Annotation*
</code></pre></div></div><h3 id="crashlytics">Crashlytics</h3><p><a href="https://try.crashlytics.com">Crashlytics</a>는 이미 ProGuard를 사용한 라이브러리들을 다시 ProGuard가 검사할 필요 없게 해서 <a href="https://fabric.io/blog/2014/02/18/mastering-proguard-for-building-lightweight-android-code">빌드 시간을 줄이는 팁</a>을 제공하고 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-libraryjars libs
-keep class com.crashlytics.** { *; }
</code></pre></div></div><p><a href="https://developer.android.com/topic/libraries/support-library/">Android Support Library</a>는 이미 소스가 공개되어 있기 때문에 코드 난독화가 필요하지 않다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-libraryjars libs
-keep class android.support.v4.app.** { *; }
-keep interface android.support.v4.app.** { *; }
</code></pre></div></div><p>ProGuard를 이용해 코드 난독화 작업을 거치게 되면, 소스 파일의 줄 번호가 바뀌게 되어 Crashlytics의 스택 트레이스에서 정보를 얻기 어려울 수 있다. <a href="https://web.archive.org/web/20161206085850/https://support.crashlytics.com/knowledgebase/articles/202926-android-studio-and-intellij-with-proguard">소스 파일의 줄 번호 정보를 유지</a>하려면 다음 문장을 추가한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-keepattributes SourceFile,LineNumberTable
</code></pre></div></div><p>다만 이 코드 때문에 난독화가 덜 되는 것 같다는 생각이 든다면, 파일 이름을 모두 <code class="language-plaintext highlighter-rouge">"SourceFile"</code> 문자열로 <a href="https://www.guardsquare.com/en/products/proguard/manual/examples#stacktrace">바꿀 수도 있다</a>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-renamesourcefileattribute SourceFile
-keepattributes SourceFile,LineNumberTable
</code></pre></div></div><h3 id="google-play-services-sdk">Google Play Services SDK</h3><p><a href="https://developers.google.com/android/guides/overview">Google Play Services SDK</a> 또한 필요한 클래스가 사라지는 것을 방지하기 위한 <a href="https://developer.android.com/google/play-services/setup.html#Proguard">ProGuard 규칙</a>을 제공하고 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-keep class * extends java.util.ListResourceBundle {
    protected Object[][] getContents();
}

-keep public class com.google.android.gms.common.internal.safeparcel.SafeParcelable {
    public static final *** NULL;
}

-keepnames @com.google.android.gms.common.annotation.KeepName class *
-keepclassmembernames class * {
    @com.google.android.gms.common.annotation.KeepName *;
}

-keepnames class * implements android.os.Parcelable {
    public static final ** CREATOR;
}
</code></pre></div></div><h2 id="see-also">참고 목록</h2><ul><li><a href="http://tools.android.com/tech-docs/new-build-system/user-guide">Gradle Plugin User Guide</a> by <a href="http://tools.android.com">Android Tools Project Site</a><li><a href="https://fabric.io/blog/2014/02/18/mastering-proguard-for-building-lightweight-android-code">Mastering ProGuard for Building Lightweight Android Code</a> by <a href="https://try.crashlytics.com">Crashlytics</a><li><a href="https://www.guardsquare.com/en/products/proguard/manual">ProGuard Manual</a> by <a href="https://www.guardsquare.com/en/products/proguard">ProGuard</a><li><a href="http://novafactory.net/archives/2845">Gradle - Progaurd 사용하기(proguard rule)</a> (<a href="https://web.archive.org/web/20160805062722/http://novafactory.net/archives/2845">archive</a> by <a href="https://plus.google.com/113131691466488717287">Nova</a></ul></div></article></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2021 - <a href="/about/">Yous</a> - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://yous.be/atom.xml">RSS</a></p></div></footer>
