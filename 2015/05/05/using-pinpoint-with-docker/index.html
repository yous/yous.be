<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Using Pinpoint with Docker</title><meta name="description" content="How to use Pinpoint with Docker."><meta name="keywords" content="pinpoint, docker"><link rel="stylesheet" href="/assets/main.css"><link rel="canonical" href="https://yous.be/2015/05/05/using-pinpoint-with-docker/"><link rel="alternate" type="application/rss+xml" title="Yous" href="https://yous.be/atom.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" href="/icon-192x192.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="mask-icon" color="#2568ba" href="/safari-pinned-tab.svg"><meta name="msapplication-TileColor" content="#2568ba"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="Using Pinpoint with Docker"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/2015/05/05/using-pinpoint-with-docker/"><meta property="og:description" content="How to use Pinpoint with Docker."><meta property="og:image" content="http://yous.be/images/2015/05/05/logo.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Using Pinpoint with Docker"><meta name="twitter:description" content="How to use Pinpoint with Docker."><meta name="twitter:image:src" content="http://yous.be/images/2015/05/05/logo.png"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZKJJ9M5EL"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KZKJJ9M5EL'); </script><body><header class="site-header"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Using Pinpoint with Docker</h1><p class="post-meta"><time datetime="2015-05-05T03:12:07+00:00" itemprop="datePublished">May 5, 2015</time> • <a href="/categories/technology/">Technology</a></p></header><div class="post-content" itemprop="articleBody"><p><img src="/images/2015/05/05/logo.min.png" alt="Pinpoint" /></p><blockquote><p><a href="https://github.com/pinpoint-apm/pinpoint"><strong>Pinpoint</strong></a> is an open source APM (Application Performance Management) tool for large-scale distributed systems written in Java.</p></blockquote><h2>Preliminary</h2><p>In this post, our goal is to run a sample Pinpoint 1.6.x instance with QuickStart scripts. You can find them on <a href="https://github.com/pinpoint-apm/pinpoint/tree/1.6.x/quickstart">GitHub</a>. Also note that we’re going to use <a href="https://www.docker.com/">Docker</a>.</p><h2>Requirements</h2><p>First things first, install Docker.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="nt">-qO-</span> https://get.docker.com/ | sh
</code></pre></div></div><p>You can verify <code class="language-plaintext highlighter-rouge">docker</code> is installed correctly.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run hello-world
</code></pre></div></div><p>For more details, see the <a href="https://web.archive.org/web/20150526062842/https://docs.docker.com/installation/#installation">installation guides</a> of Docker.</p><h2>Look into the Dockerfile</h2><p>In fact, I already made a Dockerfile for Pinpoint. You can see on <a href="https://github.com/yous/pinpoint-docker">yous/pinpoint-docker</a>. From now on, I’ll describe the Dockerfile line by line.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> debian</span>
</code></pre></div></div><p><a href="https://docs.docker.com/reference/builder/#from"><code class="language-plaintext highlighter-rouge">FROM</code></a> instruction sets the base image of the Docker. We use lateste debian image.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'deb http://http.debian.net/debian/ wheezy contrib'</span> <span class="o">&gt;&gt;</span> /etc/apt/sources.list
<span class="k">RUN </span>apt-get update
</code></pre></div></div><p><a href="https://docs.docker.com/reference/builder/#run"><code class="language-plaintext highlighter-rouge">RUN</code></a> instruction executes commands in Docker. We add <code class="language-plaintext highlighter-rouge">http://http.debian.net/debian/ wheezy contrib</code> to the <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list</code> for <code class="language-plaintext highlighter-rouge">java-package</code> package, and then run <code class="language-plaintext highlighter-rouge">apt-get update</code>.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> git wget curl procps net-tools
<span class="k">RUN </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> java-package fakeroot
</code></pre></div></div><p>In this section, we install basic tools like <code class="language-plaintext highlighter-rouge">git</code>, <code class="language-plaintext highlighter-rouge">wget</code>, <code class="language-plaintext highlighter-rouge">curl</code>. Also <code class="language-plaintext highlighter-rouge">procps</code> contains <code class="language-plaintext highlighter-rouge">ps</code>, <code class="language-plaintext highlighter-rouge">net-tools</code> contains <code class="language-plaintext highlighter-rouge">netstat</code> which is used by QuickStart scripts later.</p><p>Note the <code class="language-plaintext highlighter-rouge">DEBIAN_FRONTEND=noninteractive</code>, this is only for the <code class="language-plaintext highlighter-rouge">apt-get install</code> while building a Docker image, and this suppresses warning messages of <code class="language-plaintext highlighter-rouge">apt-get install</code>. Also we can set <code class="language-plaintext highlighter-rouge">DEBIAN_FRONTEND</code> with:</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> DEBIAN_FRONTEND noninteractive</span>
</code></pre></div></div><p>But we won’t add this line because when <code class="language-plaintext highlighter-rouge">ENV</code> sets, it will remain even after it finished the build. This is bad when we run the Docker image by <code class="language-plaintext highlighter-rouge">docker run -i -t ... bash</code>, the Docker is interactive, but the <code class="language-plaintext highlighter-rouge">DEBIAN_FRONTEND</code> is set wrong. So we’ll only set it inline. You can see the information on <a href="https://github.com/docker/docker/issues/4032">docker/docker#4032</a>.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span>useradd pinpoint <span class="nt">-m</span>
</code></pre></div></div><p>As <a href="https://github.com/pinpoint-apm/pinpoint/blob/1.6.x/doc/installation.md">installation guide of Pinpoint</a> indicates, we need to install JDK 6 and JDK 7+. To install Java, we need a non-root user. So we add a user <code class="language-plaintext highlighter-rouge">pinpoint</code> and create its home directory by passing <code class="language-plaintext highlighter-rouge">-m</code>. Adding a user is needed to install Java.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WORKDIR</span><span class="s"> /home/pinpoint</span>
</code></pre></div></div><p><a href="https://docs.docker.com/reference/builder/#workdir"><code class="language-plaintext highlighter-rouge">WORKDIR</code></a> instruction sets the working directory for Docker. After this line, any <code class="language-plaintext highlighter-rouge">RUN</code> instructions are runned in this working directory.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span>wget <span class="nt">--no-cookies</span> <span class="nt">--header</span> <span class="s2">"Cookie: oraclelicense=accept-securebackup-cookie"</span> <span class="se">\
</span>  http://download.oracle.com/otn-pub/java/jdk/6u45-b06/jdk-6u45-linux-x64.bin
<span class="k">RUN </span><span class="nb">chown </span>pinpoint jdk-6u45-linux-x64.bin
<span class="k">RUN </span>su pinpoint <span class="nt">-c</span> <span class="s1">'yes | fakeroot make-jpkg jdk-6u45-linux-x64.bin'</span>
<span class="k">RUN </span><span class="nb">rm </span>jdk-6u45-linux-x64.bin
<span class="k">RUN </span>dpkg <span class="nt">-i</span> oracle-j2sdk1.6_1.6.0+update45_amd64.deb
<span class="k">RUN </span><span class="nb">rm </span>oracle-j2sdk1.6_1.6.0+update45_amd64.deb

<span class="k">RUN </span>wget <span class="nt">--no-cookies</span> <span class="nt">--header</span> <span class="s2">"Cookie: oraclelicense=accept-securebackup-cookie"</span> <span class="se">\
</span>  http://download.oracle.com/otn-pub/java/jdk/7u79-b15/jdk-7u79-linux-x64.tar.gz
<span class="k">RUN </span><span class="nb">chown </span>pinpoint jdk-7u79-linux-x64.tar.gz
<span class="k">RUN </span>su pinpoint <span class="nt">-c</span> <span class="s1">'yes | fakeroot make-jpkg jdk-7u79-linux-x64.tar.gz'</span>
<span class="k">RUN </span><span class="nb">rm </span>jdk-7u79-linux-x64.tar.gz
<span class="k">RUN </span>dpkg <span class="nt">-i</span> oracle-j2sdk1.7_1.7.0+update79_amd64.deb
<span class="k">RUN </span><span class="nb">rm </span>oracle-j2sdk1.7_1.7.0+update79_amd64.deb
</code></pre></div></div><p>Now we install Java SE 6 and then Java SE 7 on the Docker. The <code class="language-plaintext highlighter-rouge">wget</code> script is from <a href="http://stackoverflow.com/a/10959815/3108885">“How to automate download and installation of Java JDK on Linux?”</a>. Running <code class="language-plaintext highlighter-rouge">fakeroot make-jpkg ...</code> and <code class="language-plaintext highlighter-rouge">dpkg -i ...</code> installs Java.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> JAVA_6_HOME /usr/lib/jvm/j2sdk1.6-oracle</span>
<span class="k">ENV</span><span class="s"> JAVA_7_HOME /usr/lib/jvm/j2sdk1.7-oracle</span>
<span class="k">ENV</span><span class="s"> JAVA_HOME /usr/lib/jvm/j2sdk1.7-oracle</span>
</code></pre></div></div><p>For the requirements of Pinpoint, we set <code class="language-plaintext highlighter-rouge">JAVA_6_HOME</code>, <code class="language-plaintext highlighter-rouge">JAVA_7_HOME</code> and <code class="language-plaintext highlighter-rouge">JAVA_HOME</code> environment variables.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WORKDIR</span><span class="s"> /usr/local/apache-maven</span>
</code></pre></div></div><p>Now we’re going to install Maven.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ADD</span><span class="s"> http://mirror.apache-kr.org/maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz ./</span>
<span class="k">ADD</span><span class="s"> http://www.apache.org/dist//maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz.md5 ./</span>
<span class="k">ADD</span><span class="s"> http://www.apache.org/dist//maven/maven-3/3.2.5/binaries/apache-maven-3.2.5-bin.tar.gz.asc ./</span>
</code></pre></div></div><p><a href="https://docs.docker.com/reference/builder/#add"><code class="language-plaintext highlighter-rouge">ADD</code></a> instructions copies new files, directories, or remote file from URL to the specified path. Above lines just download Maven files from Apache mirror.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span><span class="o">[</span> <span class="si">$(</span><span class="nb">md5sum </span>apache-maven-3.2.5-bin.tar.gz | <span class="nb">grep</span> <span class="nt">--only-matching</span> <span class="nt">-m</span> 1 <span class="s1">'^[0-9a-f]*'</span><span class="si">)</span> <span class="o">=</span> <span class="si">$(</span><span class="nb">cat </span>apache-maven-3.2.5-bin.tar.gz.md5<span class="si">)</span> <span class="o">]</span>
</code></pre></div></div><p>This matches MD5 hash checksum of <code class="language-plaintext highlighter-rouge">apache-maven-3.2.5-bin.tar.gz</code> with <code class="language-plaintext highlighter-rouge">apache-maven-3.2.5-bin-tar.gz.md5</code>.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span>gpg <span class="nt">--keyserver</span> pgp.mit.edu <span class="nt">--recv-key</span> BB617866
<span class="k">RUN </span>gpg <span class="nt">--verify</span> apache-maven-3.2.5-bin.tar.gz.asc apache-maven-3.2.5-bin.tar.gz
</code></pre></div></div><p>This verifies signature for <code class="language-plaintext highlighter-rouge">apache-maven-3.2.5-bin.tar.gz</code> with <code class="language-plaintext highlighter-rouge">apache-maven-3.2.5-bin.tar.gz.asc</code>.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span><span class="nb">tar</span> <span class="nt">-xf</span> apache-maven-3.2.5-bin.tar.gz
<span class="k">ENV</span><span class="s"> PATH $PATH:/usr/local/apache-maven/apache-maven-3.2.5/bin</span>
<span class="k">RUN </span><span class="nb">rm </span>apache-maven-3.2.5-bin.tar.gz apache-maven-3.2.5-bin.tar.gz.md5 apache-maven-3.2.5-bin.tar.gz.asc
</code></pre></div></div><p>Now we install Maven 3.2.5 on the Docker. Note that we have to add the path of Maven to the <code class="language-plaintext highlighter-rouge">PATH</code>.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN </span>git clone <span class="nt">-b</span> 1.6.x https://github.com/pinpoint-apm/pinpoint.git /pinpoint
<span class="k">WORKDIR</span><span class="s"> /pinpoint</span>
<span class="k">RUN </span>mvn <span class="nb">install</span> <span class="nt">-Dmaven</span>.test.skip<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div><p>All requirements are installed, so we clone Pinpoint to the <code class="language-plaintext highlighter-rouge">/pinpoint</code> and install it.</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WORKDIR</span><span class="s"> quickstart/hbase</span>
<span class="k">ADD</span><span class="s"> http://archive.apache.org/dist/hbase/hbase-0.94.25/hbase-0.94.25.tar.gz ./</span>
<span class="k">RUN </span><span class="nb">tar</span> <span class="nt">-xf</span> hbase-0.94.25.tar.gz
<span class="k">RUN </span><span class="nb">rm </span>hbase-0.94.25.tar.gz
<span class="k">RUN </span><span class="nb">ln</span> <span class="nt">-s</span> hbase-0.94.25 hbase
<span class="k">RUN </span><span class="nb">cp</span> ../conf/hbase/hbase-site.xml hbase-0.94.25/conf/
<span class="k">RUN </span><span class="nb">chmod</span> +x hbase-0.94.25/bin/start-hbase.sh
</code></pre></div></div><p>After installation of Pinpoint, we install HBase 0.94.25 as <a href="https://github.com/pinpoint-apm/pinpoint/blob/1.6.x/quickstart/bin/start-hbase.sh"><code class="language-plaintext highlighter-rouge">quickstart/bin/start-hbase.sh</code></a> of Pinpoint does it.</p><h2>Running Docker</h2><p>You can pull the Docker image:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull yous/pinpoint
</code></pre></div></div><p>Then run the image:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-t</span> yous/pinpoint bash
</code></pre></div></div><p>Also if you want to remove the container after Docker exits, use:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">--rm</span> yous/pinpoint bash
</code></pre></div></div><p>This makes you can check some requirements like <code class="language-plaintext highlighter-rouge">which java</code>, but you can’t run QuickStart scripts successfully. Since the scripts check the program name in the result of <code class="language-plaintext highlighter-rouge">netstat</code>, we should pass some option. See <a href="https://github.com/docker/docker/issues/7276">docker/docker#7276</a> for details.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">--cap-add</span> SYS_PTRACE yous/pinpoint bash
</code></pre></div></div><p>Also, note that we are going to use port 28080, 28081 and 28082 in QuickStart. So binding a container’s port to a specific port is needed. <code class="language-plaintext highlighter-rouge">-p</code> flag will do it. See <a href="https://docs.docker.com/userguide/dockerlinks/">Linking Containers Together</a> for details.</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">-p</span> 28080:28080 <span class="nt">-p</span> 28081:28081 <span class="nt">-p</span> 28082:28082 <span class="se">\</span>
  <span class="nt">--cap-add</span> SYS_PTRACE yous/pinpoint bash
</code></pre></div></div><h2>QuickStart</h2><p>We built a Docker image for Pinpoint, so now we can run QuickStart scripts. As mentioned in <a href="https://github.com/pinpoint-apm/pinpoint/blob/1.6.x/quickstart/README.md">QuickStart</a> of Pinpoint, we run several scripts.</p><h3>Install &amp; Start HBase</h3><ul><li>Download &amp; Start: <code class="language-plaintext highlighter-rouge">quickstart/bin/start-hbase.sh</code><li>Initialize Tables: <code class="language-plaintext highlighter-rouge">quickstart/bin/init-hbase.sh</code></ul><h3>Start Pinpoint Daemons</h3><ul><li><p>Collector: <code class="language-plaintext highlighter-rouge">quickstart/bin/start-collector.sh</code></p><p><img src="/images/2015/05/05/quickstart-start-collector.min.png" alt="Running start-collector.sh" /></p><li><p>Web UI: <code class="language-plaintext highlighter-rouge">quickstart/bin/start-web.sh</code></p><p><img src="/images/2015/05/05/quickstart-start-web.min.png" alt="Running start-web.sh" /></p><li><p>TestApp: <code class="language-plaintext highlighter-rouge">quickstart/bin/start-testapp.sh</code></p><p><img src="/images/2015/05/05/quickstart-start-testapp.min.png" alt="Running start-testapp.sh" /></p></ul><p>Once HBase and the 3 daemons are running, visit the following addresses to test out your Pinpoint instance.</p><ul><li><p>Web UI: <a href="http://localhost:28080">http://localhost:28080</a></p><p><img src="/images/2015/05/05/quickstart-web-ui.min.png" alt="Screenshot of Web UI" /></p><li><p>TestApp: <a href="http://localhost:28081">http://localhost:28081</a></p><p><img src="/images/2015/05/05/quickstart-testapp.min.png" alt="Screenshot of TestApp" /></p></ul><h3>Stopping</h3><ul><li>HBase: <code class="language-plaintext highlighter-rouge">quickstart/bin/stop-hbase.sh</code><li>Collector: <code class="language-plaintext highlighter-rouge">quickstart/bin/stop-collector.sh</code><li>Web UI: <code class="language-plaintext highlighter-rouge">quickstart/bin/stop-web.sh</code><li>TestApp: <code class="language-plaintext highlighter-rouge">quickstart/bin/stop-testapp.sh</code></ul><h2>Summary</h2><p>You can run Pinpoint on Docker by:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull yous/pinpoint
docker run <span class="nt">-i</span> <span class="nt">-t</span> <span class="nt">-p</span> 28080:28080 <span class="nt">-p</span> 28081:28081 <span class="nt">-p</span> 28082:28082 <span class="se">\</span>
  <span class="nt">--cap-add</span> SYS_PTRACE yous/pinpoint bash
</code></pre></div></div><p>Inside the Docker, run:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>quickstart/bin/start-hbase.sh
quickstart/bin/init-hbase.sh
quickstart/bin/start-collector.sh
quickstart/bin/start-web.sh
quickstart/bin/start-testapp.sh
</code></pre></div></div><p>Then you can access <a href="http://localhost:28080">http://localhost:28080</a> for Web UI and <a href="http://localhost:28081">http://localhost:28081</a> for TestApp.</p><p>Note again, you can see my Dockerfile on <a href="https://github.com/yous/pinpoint-docker">yous/pinpoint-docker</a>. Any issues and pull requests are welcome!</p></div></article></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2023 - <a href="/about/">Yous</a> - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://yous.be/atom.xml">RSS</a></p></div></footer>
