<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>32C3 CTF 2015: libdroid Write-up</title><meta name="description" content="Write-up of 32C3 CTF 2015: libdroid."><meta name="keywords" content="32c3, 32c3 ctf 2015, libdroid, android, write-up"><link rel="stylesheet" href="/assets/main.css"><link rel="canonical" href="https://yous.be/2015/12/30/32c3-ctf-2015-libdroid-write-up/"><link rel="alternate" type="application/rss+xml" title="Yous" href="https://yous.be/atom.xml"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="icon" type="image/png" href="/icon-192x192.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="mask-icon" color="#2568ba" href="/safari-pinned-tab.svg"><meta name="msapplication-TileColor" content="#2568ba"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta property="fb:admins" content="100001802412550"><meta property="og:title" content="32C3 CTF 2015: libdroid Write-up"><meta property="og:site_name" content="Yous"><meta property="og:url" content="https://yous.be/2015/12/30/32c3-ctf-2015-libdroid-write-up/"><meta property="og:description" content="Write-up of 32C3 CTF 2015: libdroid."><meta property="og:image" content="http://yous.be/images/2015/12/30/jd-gui.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="32C3 CTF 2015: libdroid Write-up"><meta name="twitter:description" content="Write-up of 32C3 CTF 2015: libdroid."><meta name="twitter:image:src" content="http://yous.be/images/2015/12/30/jd-gui.png"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KZKJJ9M5EL"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KZKJJ9M5EL'); </script><body><header class="site-header"><div class="wrapper"> <a class="site-title" href="/">Yous</a><nav class="site-nav"> <a class="page-link" href="/about/">About</a> <a class="page-link" href="/archives/">Archives</a></nav></div></header><main class="page-content" aria-label="Content"><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">32C3 CTF 2015: libdroid Write-up</h1><p class="post-meta"><time datetime="2015-12-30T16:59:51+00:00" itemprop="datePublished">Dec 30, 2015</time> • <a href="/categories/ctf/">CTF</a></p></header><div class="post-content" itemprop="articleBody"><h2>Reversing (150)</h2><blockquote><p>Solves: 17</p><p>Please install <a href="https://32c3ctf.ccc.ac/uploads/libdroid_fixed.tar.gz">this</a> on your new android phone, enter pass code and get the flag.</p><p><strong>Hints:</strong></p><ul><li>Updated the libdroid.apk, this one is now also able to run on a device. No changes to internal logic.</ul></blockquote><p>If the above link doesn’t work, please use this <a href="/downloads/2015/12/30/libdroid_fixed.tar.gz">link</a>.</p><h3>Decompiling the APK</h3><p>First things first, rename the <code class="language-plaintext highlighter-rouge">libdroid_fixed.apk</code> to <code class="language-plaintext highlighter-rouge">libdroid_fixed.zip</code> and unzip it. Then there should be a <code class="language-plaintext highlighter-rouge">classes.dex</code> file, and we have <a href="https://sourceforge.net/projects/dex2jar/">dex2jar</a>.</p><p>On Windows,</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>d2j-dex2jar.bat classes.dex
</code></pre></div></div><p>Otherwise,</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dsj-dex2jar.sh classes.dex
</code></pre></div></div><p>Then we can obtain <code class="language-plaintext highlighter-rouge">classes-dex2jar.jar</code>, now it’s <a href="http://jd.benow.ca/">JD-GUI</a>’s turn. Open the jar file with JD-GUI and you will see the content of class <code class="language-plaintext highlighter-rouge">ctf.stratumauhhur.libdroid.a</code>.</p><p><img src="/images/2015/12/30/jd-gui.min.png" alt="JD-GUI navigating classes-dex2jar.jar" /></p><p>The full content of the <code class="language-plaintext highlighter-rouge">a.class</code> is available on <a href="https://gist.github.com/yous/43bc6f60d41d0197cf18">this gist</a>.</p><p>There are quite many methods with name <code class="language-plaintext highlighter-rouge">a</code> in class <code class="language-plaintext highlighter-rouge">ctf.stratumauhhur.libdroid.a</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="nc">String</span> <span class="nf">a</span><span class="o">(</span><span class="nc">String</span> <span class="n">paramString</span><span class="o">,</span> <span class="kt">int</span> <span class="n">paramInt</span><span class="o">)</span> <span class="o">{...}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">a</span><span class="o">(</span><span class="nc">View</span> <span class="n">paramView</span><span class="o">)</span> <span class="o">{...}</span>
<span class="kt">void</span> <span class="nf">a</span><span class="o">(</span><span class="nc">String</span> <span class="n">paramString</span><span class="o">)</span> <span class="o">{...}</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="nf">a</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">paramArrayOfByte</span><span class="o">,</span> <span class="nc">String</span> <span class="n">paramString</span><span class="o">)</span> <span class="o">{...}</span>
</code></pre></div></div><p>At first, static variables of the class are assigned, and since the class is an activity, <code class="language-plaintext highlighter-rouge">protected void onCreate(Bundle paramBundle)</code> should be called.</p><p>The following is the code assigning static variables:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="nc">String</span> <span class="n">a</span><span class="o">;</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">b</span><span class="o">;</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">c</span><span class="o">;</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">d</span><span class="o">;</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">f</span><span class="o">;</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">getFlag</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
<span class="kd">static</span> <span class="nc">String</span> <span class="n">g</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">e</span><span class="o">;</span>

<span class="kd">static</span>
<span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"libdroid"</span><span class="o">);</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">getOperatingSystem</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">getPhoneNumber</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">installRootkit</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">generateConfusion</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">obtainWorldDomination</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">a</span><span class="o">(</span><span class="n">installiOS</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>The method <code class="language-plaintext highlighter-rouge">static String a(String paramString, int paramInt)</code> is used for the static variables, and <code class="language-plaintext highlighter-rouge">getFlag()</code>, <code class="language-plaintext highlighter-rouge">getOperatingSystem()</code>, <code class="language-plaintext highlighter-rouge">getPhoneNumber()</code>, <code class="language-plaintext highlighter-rouge">installRootkit()</code>, <code class="language-plaintext highlighter-rouge">generateConfusion()</code>, <code class="language-plaintext highlighter-rouge">obtainWorldDomination()</code>, <code class="language-plaintext highlighter-rouge">installiOS()</code> are native methods.</p><p>We should look into the <code class="language-plaintext highlighter-rouge">static String a(String paramString, int paramInt)</code>. See the following lines:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Object</span> <span class="n">localObject1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Exception</span><span class="o">().</span><span class="na">getStackTrace</span><span class="o">()[</span><span class="n">paramInt</span><span class="o">];</span>
<span class="nc">Object</span> <span class="n">localObject2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
<span class="o">((</span><span class="nc">StringBuilder</span><span class="o">)</span><span class="n">localObject2</span><span class="o">).</span><span class="na">append</span><span class="o">(((</span><span class="nc">StackTraceElement</span><span class="o">)</span><span class="n">localObject1</span><span class="o">).</span><span class="na">getClassName</span><span class="o">()).</span><span class="na">insert</span><span class="o">(</span><span class="n">paramInt</span><span class="o">,</span> <span class="o">((</span><span class="nc">StackTraceElement</span><span class="o">)</span><span class="n">localObject1</span><span class="o">).</span><span class="na">getMethodName</span><span class="o">());</span>
<span class="n">localObject1</span> <span class="o">=</span> <span class="n">localObject2</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">paramInt</code> is always 1, so <code class="language-plaintext highlighter-rouge">localObject1</code> is <code class="language-plaintext highlighter-rouge">new Exception().getStackTrace()[1]</code>, and it’s the name of class is <code class="language-plaintext highlighter-rouge">ctf.stratumauhhur.libdroid.a</code>, and the name of method is <code class="language-plaintext highlighter-rouge">&lt;clinit&gt;</code>. So, the value of <code class="language-plaintext highlighter-rouge">localObject1</code> will be <code class="language-plaintext highlighter-rouge">"c&lt;clinit&gt;tf.stratumauhhur.libdroid.a"</code>.</p><h3>The native methods</h3><p>To know the behavior of native methods, we should decompile <code class="language-plaintext highlighter-rouge">lib/x86/liblibdroid.so</code> file using IDA, OllyDbg, or something. By looking into it, we can easily know that the native methods just return constant string. This piece of Ruby code will translate them.</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">int</span><span class="p">)</span>
  <span class="n">obj1</span> <span class="o">=</span> <span class="s1">'c&lt;clinit&gt;tf.stratumauhhur.libdroid.a'</span>
  <span class="n">obj2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">str</span><span class="p">.</span><span class="nf">size</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">int</span> <span class="o">=</span> <span class="n">obj1</span><span class="p">.</span><span class="nf">size</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">str</span><span class="p">.</span><span class="nf">size</span>
      <span class="n">j</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">ord</span>
      <span class="n">obj2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj1</span><span class="p">[</span><span class="n">int</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nf">ord</span> <span class="o">^</span> <span class="n">j</span> <span class="o">^</span> <span class="mh">0x12</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">str</span><span class="p">.</span><span class="nf">size</span>
        <span class="k">return</span> <span class="n">obj2</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">}.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chr</span><span class="p">).</span><span class="nf">join</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">obj2</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">}.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chr</span><span class="p">).</span><span class="nf">join</span>
    <span class="k">end</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">ord</span>
    <span class="n">obj2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj1</span><span class="p">[</span><span class="n">int</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nf">ord</span> <span class="o">^</span> <span class="n">j</span> <span class="o">^</span> <span class="mh">0xFA</span><span class="p">)</span>
    <span class="n">int</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">int</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="n">int</span> <span class="o">=</span> <span class="n">obj1</span><span class="p">.</span><span class="nf">size</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">getOperatingSystem</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x10\xF4\x52\xB2\x1F\xF9\x55\xFA\x13\xFC</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">getPhoneNumber</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x11\xF7\x5D\xB6\x1A\xFF\x19\xFF\x1C\xF7\x0C\xE9</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">generateConfusion</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x53\xAA\x0E\xE7\x42\xAB\x4D\xA4\x45\xAC\x50</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">getFlag</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x20\xF4\x4E\xA6\x0F\xBE\x15\xFC\x5D\xE7\x0F\xE7\x02\xF5\x19\xEC\x5B\xF5\x11\xE4\x1C\xAD\x0F\xFD\x47\xB5\x52</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">installRootkit</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x30\xF4\x52\xB3\x04\xFF\x0F\xE6\x11\xF4</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">obtainWorldDomination</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x18\xFE\x45\xE9</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>
<span class="n">installiOS</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x01\xF4\x53\xA0\x1D\xF7\x0F\xAE</span><span class="s2">"</span><span class="p">.</span><span class="nf">bytes</span>

<span class="n">_flag</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">getFlag</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "Sorry no rootkit for you :("</span>
<span class="n">_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">getOperatingSystem</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "config.ini"</span>
<span class="n">_b</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">getPhoneNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "blablablabla"</span>
<span class="n">_c</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">installRootkit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "Congratula"</span>
<span class="n">_d</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">generateConfusion</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; " 1234567890"</span>
<span class="n">_f</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">obtainWorldDomination</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "key="</span>
<span class="n">_g</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">installiOS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; "rootkit="</span>
</code></pre></div></div><h3>Decompiling <code class="language-plaintext highlighter-rouge">onCreate</code></h3><p>Now we have static variables, so the next thing is <code class="language-plaintext highlighter-rouge">protected void onCreate(Bundle paramBundle)</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">paramBundle</span><span class="o">)</span>
<span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">paramBundle</span><span class="o">);</span>
  <span class="n">setContentView</span><span class="o">(</span><span class="mi">2130968601</span><span class="o">);</span>
  <span class="k">try</span>
  <span class="o">{</span>
    <span class="n">a</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">paramBundle</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The method is <code class="language-plaintext highlighter-rouge">void a(String paramString)</code>, and the variable <code class="language-plaintext highlighter-rouge">a</code> is static variable that we have calculated right before, which is <code class="language-plaintext highlighter-rouge">"config.ini"</code>. Then let’s look into the method.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">a</span><span class="o">(</span><span class="nc">String</span> <span class="n">paramString</span><span class="o">)</span>
  <span class="kd">throws</span> <span class="nc">Exception</span>
<span class="o">{</span>
  <span class="n">paramString</span> <span class="o">=</span> <span class="n">getAssets</span><span class="o">().</span><span class="na">open</span><span class="o">(</span><span class="n">paramString</span><span class="o">);</span>
  <span class="nc">Object</span> <span class="n">localObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
  <span class="kt">byte</span><span class="o">[]</span> <span class="n">arrayOfByte</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mh">0x4000</span><span class="o">];</span>
  <span class="k">for</span> <span class="o">(;;)</span>
  <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">paramString</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">arrayOfByte</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">arrayOfByte</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">write</span><span class="o">(</span><span class="n">arrayOfByte</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">flush</span><span class="o">();</span>
  <span class="n">paramString</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">a</span><span class="o">(((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">b</span><span class="o">))));</span>
  <span class="k">for</span> <span class="o">(;;)</span>
  <span class="o">{</span>
    <span class="n">localObject</span> <span class="o">=</span> <span class="n">paramString</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">localObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(((</span><span class="nc">String</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">startsWith</span><span class="o">(</span><span class="n">g</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">g</span> <span class="o">=</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">substring</span><span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(((</span><span class="nc">String</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">startsWith</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">f</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span><span class="nc">Base64</span><span class="o">.</span><span class="na">decode</span><span class="o">(((</span><span class="nc">String</span><span class="o">)</span><span class="n">localObject</span><span class="o">).</span><span class="na">substring</span><span class="o">(((</span><span class="nc">String</span><span class="o">)</span><span class="n">f</span><span class="o">).</span><span class="na">length</span><span class="o">()),</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>It reads an asset with its name <code class="language-plaintext highlighter-rouge">paramString</code> into <code class="language-plaintext highlighter-rouge">localObject</code>, and then execute <code class="language-plaintext highlighter-rouge">byte[] a(byte[] paramArrayOfByte, String paramString)</code> with <code class="language-plaintext highlighter-rouge">localObject</code> and <code class="language-plaintext highlighter-rouge">b</code>.</p><p>Again, this is the Ruby version of the code. You can find <code class="language-plaintext highlighter-rouge">config.ini</code> in the <code class="language-plaintext highlighter-rouge">assets</code> directory.</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">byte_a</span><span class="p">(</span><span class="n">paramArrayOfByte</span><span class="p">,</span> <span class="n">paramString</span><span class="p">)</span>
  <span class="n">arrayOfByte</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">paramArrayOfByte</span><span class="p">.</span><span class="nf">size</span>
  <span class="n">arrayOfByte</span><span class="p">.</span><span class="nf">size</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
    <span class="n">arrayOfByte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">paramArrayOfByte</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">ord</span> <span class="o">^</span> <span class="n">paramString</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">paramString</span><span class="p">.</span><span class="nf">size</span><span class="p">].</span><span class="nf">ord</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">arrayOfByte</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chr</span><span class="p">).</span><span class="nf">join</span>
<span class="k">end</span>

<span class="n">config_ini</span> <span class="o">=</span> <span class="s2">"^</span><span class="se">\x1E\x0E\r\x18</span><span class="s2">_h</span><span class="se">\a\x04\e</span><span class="s2">Q(3/&amp;</span><span class="se">\x16</span><span class="s2">CJ%40;</span><span class="se">\x18</span><span class="s2">,#Q</span><span class="se">\\</span><span class="s2">h</span><span class="se">\x1E\x0E\r</span><span class="s2">"</span> <span class="p">\</span>
  <span class="s2">"</span><span class="se">\x18\n\v\x18\\\x03</span><span class="s2">C</span><span class="se">\x05</span><span class="s2">M</span><span class="se">\x0F</span><span class="s2">N</span><span class="se">\x01</span><span class="s2">B</span><span class="se">\x05\x03\x18</span><span class="s2">k^C</span><span class="se">\x13\r\x03\x15\\</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="n">paramString</span> <span class="o">=</span> <span class="n">byte_a</span><span class="p">(</span><span class="n">config_ini</span><span class="p">,</span> <span class="n">_b</span><span class="p">)</span>
<span class="c1"># &lt;root&gt;</span>
<span class="c1"># key=IQCGt/+GXQYtMA==</span>
<span class="c1"># rootkit=a/d/c/c.dat</span>
<span class="c1"># &lt;/root&gt;</span>
</code></pre></div></div><p>So <code class="language-plaintext highlighter-rouge">g</code> will be replaced with <code class="language-plaintext highlighter-rouge">"a/d/c/c.dat"</code>, and <code class="language-plaintext highlighter-rouge">f</code> will be replaced with the value of <code class="language-plaintext highlighter-rouge">Base64.decode("IQCGt/+GXQYtMA==")</code>, which is <code class="language-plaintext highlighter-rouge">"!\x00\x86\xB7\xFF\x86]\x06-0"</code>.</p><h3>The main logic</h3><p>Now we’re almost close. There’s only <code class="language-plaintext highlighter-rouge">public void a(View paramView)</code> left to analyze.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492969</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492970</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492971</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492972</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492973</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492974</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492975</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492977</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492978</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492976</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">+=</span> <span class="n">d</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>Obviously, this handles a button click. <code class="language-plaintext highlighter-rouge">d</code> is <code class="language-plaintext highlighter-rouge">" 1234567890"</code>, so we can think the button 1 to 9 is mapped to <code class="language-plaintext highlighter-rouge">"1"</code> to <code class="language-plaintext highlighter-rouge">"9"</code> respectively, and the button 0 is mapped to <code class="language-plaintext highlighter-rouge">" "</code>.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">str</span><span class="o">;</span>
<span class="nc">Object</span> <span class="n">localObject2</span><span class="o">;</span>
<span class="nc">Object</span> <span class="n">localObject1</span><span class="o">;</span>
<span class="k">if</span> <span class="o">((</span><span class="k">this</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">6</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">paramView</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2131492979</span><span class="o">))</span>
<span class="o">{</span>
  <span class="n">str</span> <span class="o">=</span> <span class="n">flag</span><span class="o">;</span>
  <span class="k">try</span>
  <span class="o">{</span>
    <span class="nc">InputStream</span> <span class="n">localInputStream</span> <span class="o">=</span> <span class="n">getAssets</span><span class="o">().</span><span class="na">open</span><span class="o">(</span><span class="n">g</span><span class="o">);</span>
    <span class="n">localObject2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">arrayOfByte</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mh">0x4000</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(;;)</span>
    <span class="o">{</span>
      <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">localInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">arrayOfByte</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">arrayOfByte</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="o">((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject2</span><span class="o">).</span><span class="na">write</span><span class="o">(</span><span class="n">arrayOfByte</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">Snackbar</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">paramView</span><span class="o">,</span> <span class="o">(</span><span class="nc">CharSequence</span><span class="o">)</span><span class="n">localObject1</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">setAction</span><span class="o">(</span><span class="s">"Action"</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">localException</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="n">localException</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">localObject1</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="k">for</span> <span class="o">(;;)</span>
<span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">e</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
  <span class="k">return</span><span class="o">;</span>
  <span class="o">((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject2</span><span class="o">).</span><span class="na">flush</span><span class="o">();</span>
  <span class="n">localObject2</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ByteArrayOutputStream</span><span class="o">)</span><span class="n">localObject2</span><span class="o">).</span><span class="na">toByteArray</span><span class="o">();</span>
  <span class="n">localObject1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">];</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">localObject1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">f</span><span class="o">).</span><span class="na">length</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">localObject1</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">getBytes</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>
  <span class="n">phoneHome</span><span class="o">((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">localObject2</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span><span class="n">localObject1</span><span class="o">);</span>
  <span class="n">localObject1</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">localObject2</span><span class="o">).</span><span class="na">startsWith</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">localObject1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">((</span><span class="kt">byte</span><span class="o">[])</span><span class="n">localObject2</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Snackbar</code> line makes a toast pop-up with the value of <code class="language-plaintext highlighter-rouge">localObject1</code>, which is <code class="language-plaintext highlighter-rouge">flag</code> by default, which is <code class="language-plaintext highlighter-rouge">"Sorry no rootkit for you :("</code>. When the value of <code class="language-plaintext highlighter-rouge">localObject2</code> after the <code class="language-plaintext highlighter-rouge">phoneHome(localObject2, localObject1)</code> starts with the value of <code class="language-plaintext highlighter-rouge">c</code>, which is <code class="language-plaintext highlighter-rouge">"Congratula"</code>, the <code class="language-plaintext highlighter-rouge">localObject1</code> changes. So our goal is to find the value of <code class="language-plaintext highlighter-rouge">e</code> that leads <code class="language-plaintext highlighter-rouge">localObject1</code> to change.</p><p>The value of <code class="language-plaintext highlighter-rouge">localObject2</code> is the content of the asset with its path <code class="language-plaintext highlighter-rouge">g</code>, which is <code class="language-plaintext highlighter-rouge">assets/a/d/c/c</code>. The first 10 bytes of <code class="language-plaintext highlighter-rouge">localObject1</code> are the same with <code class="language-plaintext highlighter-rouge">f</code>, and the last 6 bytes are the value of <code class="language-plaintext highlighter-rouge">e</code>. So we need to know the value of <code class="language-plaintext highlighter-rouge">e</code>, which will be at most six digits of number.</p><h3>Emulating <code class="language-plaintext highlighter-rouge">phoneHome</code></h3><p>We can obtain a decompiled code of <code class="language-plaintext highlighter-rouge">phoneHome</code>, and this is the exploit.</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
</span>
<span class="cp">#define _BYTE unsigned char
#define BYTEn(x, n) (*((_BYTE *) &amp;(x) + n))
#define BYTE1(x) BYTEn(x, 1)
#define BYTE2(x) BYTEn(x, 2)
#define BYTE3(x) BYTEn(x, 3)
</span>
<span class="kt">void</span> <span class="nf">check</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">g</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Congratula"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">a_d_c_c</span><span class="p">[</span><span class="mi">113</span><span class="p">]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xFE\xA0\xAD\x80</span><span class="s"> Y</span><span class="se">\xAB\x12\xD7\xC3\x9C\x88\xFA</span><span class="s">,</span><span class="se">\x1D\xFC\x81</span><span class="s">""F</span><span class="se">\r\xDC\xE9\xCE\xCC</span><span class="s">Wx</span><span class="se">\xF5</span><span class="s">""A_R</span><span class="se">\x02</span><span class="s">""6</span><span class="se">\xD5</span><span class="s">""3</span><span class="se">\x18</span><span class="s">""f:@&amp;</span><span class="se">\xE8</span><span class="s">n</span><span class="se">\xB6\xCD</span><span class="s">r</span><span class="se">\xB7</span><span class="s">&lt;</span><span class="se">\x01</span><span class="s">""f</span><span class="se">\xB1</span><span class="s">O</span><span class="se">\x99</span><span class="s">#c</span><span class="se">\x95</span><span class="s">w4ai</span><span class="se">\xF6\xA9</span><span class="s">S@7ACO</span><span class="se">\x98\x95</span><span class="s">,z'&lt;</span><span class="se">\x98</span><span class="s">h</span><span class="se">\x1A\x88\xA8\xB7\x85\xBB\x15</span><span class="s">O</span><span class="se">\x1A\x01</span><span class="s">M</span><span class="se">\xC9\xC8\x9B</span><span class="s">uxW</span><span class="se">\x7F\x98\r\xD8</span><span class="s">Q</span><span class="se">\xA8\"\xB9</span><span class="s">^YMqO</span><span class="se">\x1A\x81\xA9\xBF\a</span><span class="s">)</span><span class="se">\xED\xFD\x83</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="n">v9</span><span class="p">,</span> <span class="n">v10</span><span class="p">,</span> <span class="n">v12</span><span class="p">,</span> <span class="n">v13</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="n">v15</span><span class="p">,</span> <span class="n">v17</span><span class="p">,</span> <span class="n">v18</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v16</span><span class="p">;</span>

    <span class="n">v17</span> <span class="o">=</span> <span class="n">a_d_c_c</span><span class="p">;</span>
    <span class="n">v18</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="mi">112</span><span class="p">;</span>
    <span class="n">v12</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">v4</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">v13</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">v14</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v5</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">v15</span> <span class="o">=</span> <span class="n">v17</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">v16</span> <span class="o">=</span> <span class="n">v17</span> <span class="o">+</span> <span class="p">((</span><span class="n">v5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">v7</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="n">v15</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
            <span class="n">v8</span> <span class="o">=</span> <span class="mh">0xD5B7DDE0</span><span class="p">;</span>
            <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="n">v9</span> <span class="o">-=</span> <span class="p">(</span><span class="n">v7</span> <span class="o">+</span> <span class="n">v8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">v7</span> <span class="o">+</span> <span class="n">v14</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v6</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
                <span class="n">v7</span> <span class="o">-=</span> <span class="p">(</span><span class="n">v9</span> <span class="o">+</span> <span class="n">v8</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">v9</span> <span class="o">+</span> <span class="n">v12</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v13</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">v9</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">));</span>
                <span class="n">v8</span> <span class="o">+=</span> <span class="mh">0x21524111</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">v8</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v15</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">v7</span><span class="p">;</span>
            <span class="n">v10</span> <span class="o">=</span> <span class="n">v15</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE1</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE2</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE3</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE1</span><span class="p">(</span><span class="n">v9</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE2</span><span class="p">(</span><span class="n">v9</span><span class="p">);</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">BYTE3</span><span class="p">(</span><span class="n">v9</span><span class="p">);</span>
            <span class="n">v15</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">v10</span> <span class="o">!=</span> <span class="n">v16</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">g</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Found: e: '%s'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">input</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v17</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">replace_zero</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'0'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">f</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="s">"!</span><span class="se">\x00\x86\xB7\xFF\x86</span><span class="s">]</span><span class="se">\x06</span><span class="s">-0"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">e</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%02d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%03d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%04d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%05d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
            <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="s">"%06d"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="n">replace_zero</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Executing it is simple:</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc libdroid.c <span class="nt">-m32</span> <span class="nt">-o</span> libdroid
./libdroid
Found: e: <span class="s1">'1 3875'</span>
Congratulations! The rootkit is sucessfully installed. The Flag is 32C3_this_is_build_for_flag_ship_phones
</code></pre></div></div><p>So the flag is <code class="language-plaintext highlighter-rouge">32C3_this_is_build_for_flag_ship_phones</code>. If you want to see the flag within the application, just press <code class="language-plaintext highlighter-rouge">103875</code> on it.</p><p><img src="/images/2015/12/30/libdroid_flag.min.jpg" alt="libdroid showing the flag" /></p></div></article></div></main><footer class="site-footer"><div class="wrapper"><p> Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a><br /> &copy; 2013&ndash;2023 - <a href="/about/">Yous</a> - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://yous.be/atom.xml">RSS</a></p></div></footer>
